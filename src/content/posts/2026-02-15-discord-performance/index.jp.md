---
title: "Discord: パフォーマンス最適化のケーススタディ"
description: "何兆ものメッセージを処理し、数百万人の同時ユーザーをサポートするためのDiscordのエンジニアリングの旅を深く掘り下げます。"
date: 2026-02-15
cover: "./cover.png"
---

Discordは表面上は単なるチャットアプリのように見えますが、その裏側には、何百万人ものユーザーが同時に音声、ビデオ、テキストで通信できるようにする大規模なエンジニアリングの偉業があります。特に1,900万人以上のユーザーを抱えるMidjourneyのような大規模サーバーを問題なく運営するためにDiscordが経験してきた最適化の旅は、分散システムを扱うエンジニアにとって素晴らしい教科書となります。

この記事では、Discordがどのように技術的な限界を克服し、パフォーマンスを最適化したかを主要な事例を通して探ります。

## 1. アーキテクチャの中核: アクターモデル (The Actor Model) {#the-actor-model}

Discordのアーキテクチャの基盤は、1970年代に提案された**アクターモデル (Actor Model)**です。

- **並行性管理:** 共有メモリとロックを使用する代わりに、各「アクター」が独自の状態を管理し、メッセージのみを介して通信します。これにより、デッドロックや競合状態 (Race Condition) を防ぎます。
- **ElixirとErlang:** Discordは、このモデルを完全にサポートするElixir言語を採用しました。ユーザー、ギルド（サーバー）、音声セッションなどはすべて個別の「プロセス（アクター）」として扱われます。
- **Fan-out:** ユーザーがメッセージを送信すると、ギルドプロセスがそれを受け取り、接続されている数千、数万のセッションプロセスにメッセージをコピー（Fan-out）して、リアルタイム性を保証します。

## 2. データベースの進化: CassandraからScyllaDBへ

メッセージ処理レイヤーが解決されると、次のボトルネックはデータベースでした。

- **Cassandraの限界:** 当初は拡張性の高いCassandraを使用していましたが、データが数兆件に増えると、「Hot Partition」問題やJavaベースのガベージコレクション (GC) による停止（Stop-the-world）が発生しました。
- **ScyllaDBの導入:** DiscordはC++で書かれたScyllaDBに移行しました。ScyllaDBはCassandraと互換性がありながら、コアごとのシャーディング、GCなし、より効率的なキャッシュ管理を通じて、劇的なパフォーマンス向上を実現しました。

## 3. Rustとデータサービス: Thundering Herd問題の解決

人気のあるサーバーで`@everyone`メンションが発生すると、数千のクライアントが同時にAPIを呼び出し、データベースに過負荷をかける**Thundering Herd**問題が発生しました。

- **Request Coalescing:** これを解決するために、Rustで書かれたデータサービスを導入しました。このサービスは、同時に発生する同一のリクエストを1つにまとめ（Coalescing）、データベースには1回だけクエリを送信し、その結果を待っているすべてのリクエストに返します。
- **Rustの威力:** メモリ安全性とGCがないRustの特性のおかげで、予測可能なパフォーマンスと高いスループットを達成しました。

## 4. ハードウェアの限界克服: Super-Disk

GCP (Google Cloud Platform) 環境で、ディスクパフォーマンスの問題に直面しました。

- **問題:** ローカルSSDは高速ですがデータ損失のリスクがあり、Persistent Diskは安全ですが低速でした。
- **解決策:** エンジニアたちは、LinuxのRAIDとライトスルーキャッシュを活用して、ローカルSSDの速度とPersistent Diskの安定性を兼ね備えた「Super-Disk」という抽象化レイヤーを独自に実装しました。

## 5. クライアントおよびその他の最適化

バックエンドだけでなく、クライアントやネットワーク層でもさまざまな最適化が行われました。

- **ネイティブへの回帰:** AndroidでのReact Nativeのパフォーマンス限界（特に絵文字とリストのレンダリング）を感じ、主要なUIコンポーネントをKotlin（ネイティブ）で書き直してパフォーマンスを改善しました。
- **Passive Sessions:** ユーザーが見ていないタブのトラフィックを減らす「Passive Session」の概念を導入し、帯域幅を20%節約しました。
- **Snowflake ID:** 時間順に並べ替え可能な一意のID生成システムであるSnowflakeを導入し、DBなしでもIDだけで生成時間を推測して並べ替えられるようにしました。

## 結論

Discordの事例は、単に良いツールを使うことを超えて、**「現在のボトルネックは何か？」**を正確に把握し、創造的な解決策を見つけるエンジニアリングの本質を示しています。MongoDBから始まり、Cassandraを経てScyllaDBへ、PythonからGoを経てRustへと進化してきた彼らの旅は、ユーザー体験を最優先にした執拗なパフォーマンス最適化の結果です。

> 「複雑さは美徳ではありませんが、ユーザーのために必要であれば、喜んで複雑さを受け入れます。」

これが、Discordが10年以上も高速で快適なサービスを維持している秘訣でしょう。
