#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "ğŸš€ Running Pre-Push Checks..."

# 0. Heavy Validation (Knip, Full Test, Build)
# set -e to fail fast
set -e

echo "ğŸ§¹ Checking for unused code (Knip)..."
pnpm knip

echo "ğŸ§ª Running ALL tests..."
pnpm test

echo "ğŸ—ï¸  Running Full Build..."
pnpm run build

# 1. ë²„ì „ ì •í•©ì„± ì²´í¬ (Remote vs Local)
node scripts/check-version.cjs

# 2. í˜„ì¬ ë²„ì „ ê°€ì ¸ì˜¤ê¸°
VERSION=$(node -p "require('./package.json').version")
TAG_NAME="v$VERSION"

# 3. íƒœê·¸ ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ë° ìƒì„±
if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
  echo "ğŸ·ï¸  Tag $TAG_NAME already exists."
else
  echo "ğŸ†• Creating tag $TAG_NAME..."
  git tag "$TAG_NAME"
fi

# 4. íƒœê·¸ í‘¸ì‹œ (í˜„ì¬ í‘¸ì‹œì™€ ë³„ê°œë¡œ íƒœê·¸ë§Œ ë¨¼ì € í‘¸ì‹œ)
# --no-verify: pre-push í›…ì´ ë‹¤ì‹œ ì‹¤í–‰ë˜ì§€ ì•Šë„ë¡ í•¨ (ë¬´í•œ ë£¨í”„ ë°©ì§€)
echo "â¬†ï¸  Pushing tag $TAG_NAME..."
git push origin "$TAG_NAME" --no-verify

echo "âœ… Pre-push finished. Proceeding with main push..."
